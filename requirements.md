# CSV処理・データ変換ツール 要件定義書

## プロジェクト概要
Google Apps Script (GAS) を使用した3シート連携データ処理ツール
- LPcsvシートへのCSVインポート
- PPformat・MFformatシートへの自動転記・加工
- 加工設定メニューによるカスタマイズ
- HTMLサイドバーによるミニマルUI
- 自動ログ記録機能

## 機能要件

### 1. CSVインポート機能（LPcsvシート）
- **目的**: 外部CSVファイルをLPcsvシートに取り込む
- **操作**: サイドバーのファイル選択からCSVファイルを選択
- **対応形式**: 
  - 文字コード: UTF-8, Shift_JIS
  - 区切り文字: カンマ（,）
  - 最大ファイルサイズ: 10MB
  - 最大行数: 10,000行
- **動作**:
  1. サイドバーでファイル選択
  2. CSVファイルを選択・アップロード
  3. LPcsvシートに自動で読み込み
  4. ヘッダー行を自動検出・保持
  5. 処理結果をログシートに記録

### 2. データ転記・加工機能
- **目的**: LPcsvのデータを他の2シートに転記・加工
- **転記先**:
  - **PPformatシート**: LPcsvデータの加工版
  - **MFformatシート**: LPcsvデータの別加工版
- **加工設定**:
  - 列マッピング設定（どの列をどこに転記するか）
  - データ変換ルール（フォーマット変更、計算式適用）
  - フィルタリング条件（特定条件の行のみ転記）
- **動作**:
  1. LPcsvにデータがインポートされる
  2. 設定に基づいて自動的に他シートに転記
  3. 加工ルールを適用してデータ変換
  4. 処理結果をログに記録

### 3. 加工設定メニュー
- **目的**: データ転記・加工のルール設定
- **設定項目**:
  - **列マッピング**: LPcsv列 → PPformat/MFformat列の対応
  - **データ変換**: 文字列置換、数値計算、日付フォーマット
  - **フィルタリング**: 転記対象行の条件設定
  - **出力オプション**: ヘッダー有無、空行処理など
- **UI**: サイドバー内の設定パネル

### 4. HTMLサイドバーUI
- **デザイン**: ミニマルデザイン
- **幅**: 320px固定
- **主要要素**:
  - CSVインポートセクション
  - 加工設定セクション
  - 実行ボタン
  - ログ表示エリア
  - ステータス表示
- **操作フロー**:
  1. CSVファイル選択・インポート
  2. 加工設定の確認・変更
  3. 転記・加工実行
  4. 結果確認

### 5. ログ記録機能
- **目的**: 全ての処理履歴を記録
- **ログシート**: 自動作成（シート名: "ログ"）
- **記録項目**:
  - タイムスタンプ
  - 処理種別（インポート/転記/加工）
  - 処理対象（ファイル名/シート名）
  - 処理結果（成功/失敗）
  - エラー詳細（該当時）
  - 処理件数
- **ログローテーション**: 1000行を超えたら古いログを削除

## 技術仕様

### Google Apps Script制約
- **実行時間制限**: 最大6分
- **メモリ制限**: 適切なデータ処理サイズに制限
- **ファイルアップロード**: HTMLファイル入力を使用
- **ファイルダウンロード**: Blobオブジェクトとして提供

### データ処理仕様
- **インポート先**: アクティブなスプレッドシートの新しいシート
- **エクスポート元**: アクティブシートの全データ
- **データ型**: 文字列として処理（自動型変換なし）
- **空白セル**: 空文字列として処理

### エラーハンドリング
- **ファイル形式エラー**: CSVでないファイルの検出
- **サイズ制限エラー**: ファイルサイズ・行数制限の超過
- **権限エラー**: スプレッドシート編集権限の不足
- **ネットワークエラー**: アップロード・ダウンロードの失敗

## 非機能要件

### パフォーマンス
- **インポート処理時間**: 1,000行以下で30秒以内
- **エクスポート処理時間**: 1,000行以下で10秒以内
- **UI応答時間**: ボタンクリック後3秒以内に反応

### 使いやすさ
- **操作ステップ**: 最小限（1-2クリック）
- **エラーメッセージ**: 日本語で分かりやすく表示
- **進捗表示**: 長時間処理時の進捗バー

### 互換性
- **ブラウザ**: Chrome, Firefox, Safari, Edge
- **デバイス**: デスクトップ・タブレット対応
- **権限**: Google スプレッドシート編集権限必要

## 制約事項

### 技術制約
- **外部ライブラリ**: 使用不可（GAS標準機能のみ）
- **ローカルファイル**: 直接アクセス不可
- **同時実行**: 複数ユーザーの同時実行は制限される可能性

### データ制約
- **ファイルサイズ**: 最大10MB
- **行数制限**: 最大10,000行
- **列数制限**: 最大100列
- **文字数制限**: セル当たり最大50,000文字

### 運用制約
- **インターネット接続**: 必須
- **Googleアカウント**: 必須
- **スプレッドシート権限**: 編集権限必要

## 開発方針

### 開発フェーズ
1. **Phase 1**: 基本機能実装
   - CSVインポート機能
   - CSVエクスポート機能
   - 基本UI

2. **Phase 2**: エラーハンドリング強化
   - 入力検証
   - エラーメッセージ改善
   - 進捗表示

3. **Phase 3**: 最適化・テスト
   - パフォーマンス改善
   - ユーザビリティテスト
   - バグ修正

### コーディング方針
- **可読性**: 日本語コメント必須
- **保守性**: 機能別にファイル分割
- **テスト**: 単体テスト関数を作成
- **ログ**: 処理状況の詳細ログ

## 成功基準
- **機能性**: インポート・エクスポートが正常動作
- **パフォーマンス**: 制限時間内での処理完了
- **使いやすさ**: 非技術者でも操作可能
- **安定性**: エラー発生率5%以下

## 将来拡張可能性
- **データフィルタリング**: 条件に基づくデータ抽出
- **データ変換**: 列の並び替え・データ型変換
- **複数ファイル対応**: 一括インポート・エクスポート
- **スケジュール実行**: 定期的な自動処理