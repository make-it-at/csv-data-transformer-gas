<script>
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(fetchData);

  var originalData;
  var chartColors = {
    productTypes: {
      'JP': '#4285F4',   // 日本株
      'US': '#34A853',   // 米国株
      'FUND': '#FBBC05', // 投資信託
      'MMF': '#EA4335'   // MMF
    },
    industry: [
      '#4285F4', '#34A853', '#FBBC05', '#EA4335',
      '#8064A2', '#9E9E9E', '#45B39D', '#DC7633',
      '#5B2C6F', '#CB4335', '#3498DB', '#2ECC71',
      '#F1C40F', '#E74C3C', '#9B59B6', '#1ABC9C',
      '#D35400'
    ]
  };

  function fetchData() {
    showLoading(true);
    google.script.run
      .withSuccessHandler(handleDataFetch)
      .withFailureHandler(handleFetchError)
      .getDashboardData();
  }

  function handleDataFetch(data) {
    originalData = data;
    window.lastFetchedData = data;
    
    updateSummary(data);
    populateFilterOptions(data);
    createCharts(data);
    
    showLoading(false);
  }

  function handleFetchError(error) {
    console.error('Error fetching data:', error);
    document.querySelectorAll('.loading').forEach(el => {
      el.innerText = 'データの取得に失敗しました: ' + error;
    });
  }

  function showLoading(show) {
    document.querySelectorAll('.loading').forEach(el => {
      el.style.display = show ? 'block' : 'none';
    });
  }

  function updateSummary(data) {
    document.getElementById('totalValue').innerText = formatCurrency(data.totalValue);
    document.getElementById('totalDividend').innerText = formatCurrency(data.totalDividend);
    document.getElementById('bookYield').innerText = formatPercentage(data.bookYield);
  }

  function formatCurrency(value) {
    return new Intl.NumberFormat('ja-JP', {
      style: 'currency',
      currency: 'JPY',
      maximumFractionDigits: 0
    }).format(value);
  }

  function formatPercentage(value) {
    return new Intl.NumberFormat('ja-JP', {
      style: 'percent',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(value / 100);
  }

  function populateFilterOptions(data) {
    // フィルターオプションの生成
    populateSelect('accountType', getUniqueValues(data.stockData, 'accountType'));
    populateSelect('industry', Object.keys(data.industryData));
    populateSelect('sensitivity', Object.keys(data.sensitivityData));
    populateSelect('productType', getUniqueValues(data.stockData, 'productType'), true);
  }

  function getUniqueValues(array, key) {
    return [...new Set(array.map(item => item[key]))];
  }

  function populateSelect(id, values, isProductType = false) {
    const select = document.getElementById(id);
    select.innerHTML = '<option value="all">全て</option>';
    
    values.sort().forEach(value => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = isProductType ? getProductTypeLabel(value) : value;
      select.appendChild(option);
    });
  }

  function getProductTypeLabel(type) {
    const labels = {
      'JP': '日本株',
      'US': '米国株',
      'FUND': '投資信託',
      'MMF': 'MMF'
    };
    return labels[type] || type;
  }

  function createCharts(data) {
    createIndustryChart(data);
    createProductTypeChart(data);
  }

  // チャート作成関数は次のファイルに続きます...
</script>