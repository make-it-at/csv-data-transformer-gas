# 保有株リスト更新（updatePF）仕様書

## 概要
保有株リスト更新機能は、注文一覧シートのデータを基に、現在の保有株式を集計してメインシートに反映する機能です。

## 処理フロー

### 1. 初期化
- **対象シート**: Main, 注文一覧
- **進捗表示**: 0/totalRecords
- **処理内容**: シートの存在確認、開始時間記録

### 2. 注文データ読み込み
- **対象**: 注文一覧シート
- **進捗表示**: 10% (totalRecords * 0.1)
- **処理内容**: 全データの取得

### 3. 注文データ処理
- **進捗表示**: 20% (totalRecords * 0.2)
- **処理内容**: StockDataManager.processOrders()による集計

### 4. 注文処理完了
- **進捗表示**: 40% (totalRecords * 0.4)
- **処理内容**: 集計結果の確認

### 5. メインシート更新開始
- **進捗表示**: 50% (totalRecords * 0.5)
- **処理内容**: 列インデックスの取得

### 6. シートクリア
- **進捗表示**: 60% (totalRecords * 0.6)
- **処理内容**: メインシート3行目以降をクリア

### 7. データ作成
- **進捗表示**: 70% (totalRecords * 0.7)
- **処理内容**: 新しいデータの生成

### 8. データ書き込み
- **進捗表示**: 80% (totalRecords * 0.8)
- **処理内容**: シートへの一括書き込み

### 9. フォーマット設定
- **進捗表示**: 90% (totalRecords * 0.9)
- **処理内容**: 数値フォーマットの適用

### 10. 完了
- **進捗表示**: 100% (totalRecords)
- **処理内容**: 完了メッセージ表示

## データ処理仕様

### 注文データの集計（StockDataManager.processOrders）

#### 必要なカラム
- **コード**: 銘柄コード
- **取引種類**: 購入/売却
- **数量**: 取引数量
- **単価**: 取引単価
- **口座種別**: 口座の種類
- **商品種別**: 商品の種類
- **口座名義人**: 口座の名義人

#### 集計ロジック
1. **キー生成**: `${code}|${accountType}|${accountHolder}`
2. **購入処理**: 数量と金額を加算
3. **売却処理**: 平均単価で計算して減算
4. **フィルタリング**: 保有数が0以下のデータを除外

#### 対応商品種別
- **JP**: 日本株式
- **US**: 米国株式
- **FUND**: 投資信託
- **MMF**: マネーマーケットファンド

### メインシートの列構成

#### 必須列
- **No.**: 通し番号
- **コード**: 銘柄コード
- **銘柄名**: 銘柄名称
- **保有数**: 保有株式数
- **購入価格**: 総購入価格
- **購入単価**: 平均購入単価
- **株価**: 現在の株価（数式）
- **口座種別**: 口座の種類
- **商品種別**: 商品の種類
- **口座名義人**: 口座の名義人

#### オプション列
- **業種17分類**: 業種分類
- **景気感応度**: 景気感応度

### 株価数式の設定

#### 商品種別別の数式
```javascript
// MMF
formula = `=E${index + 3}`;

// 米国株式
formula = `=IF(ISBLANK(B${index + 3}), "", GOOGLEFINANCE(B${index + 3}))`;

// 投資信託
formula = `=IF(ISBLANK(B${index + 3}), "", STOCKPRICEJP("TOSHIN", B${index + 3}))`;

// 日本株式
formula = `=IF(ISBLANK(B${index + 3}),"",STOCKPRICEJP("JP", B${index + 3}))`;
```

### 数値フォーマット

#### 通貨別フォーマット
- **日本円**: `¥#,##0.00`
- **米ドル**: `"$"#,##0.00`
- **数量**: `#,##0`

## エラーハンドリング

### 検証項目
1. **シート存在確認**: Main, 注文一覧シートの存在
2. **データ存在確認**: 注文一覧シートにデータが存在するか
3. **ヘッダー行検出**: 必要なカラムが存在するか
4. **データ検証**: 各レコードの必須項目が有効か

### エラー処理
- **無効データ**: スキップしてログに記録
- **必須カラム不足**: エラーを投げて処理を停止
- **データ形式エラー**: 該当レコードをスキップ

## パフォーマンス

### 最適化
- **一括書き込み**: データを配列にまとめて一括書き込み
- **進捗表示**: 各段階での進捗を表示
- **エラー処理**: 個別エラーで全体を停止しない

### 制限事項
- **GAS実行時間制限**: 6分以内で完了する必要
- **メモリ制限**: 大量データ処理時のメモリ使用量に注意

## ログ出力

### ログレベル
- **DEBUG**: 詳細な処理情報
- **INFO**: 処理の開始・完了
- **WARN**: 警告情報
- **ERROR**: エラー情報

### ログ内容
- 処理開始・完了時刻
- 処理件数
- エラー詳細
- 進捗状況

## 使用方法

### 実行方法
1. **メニューから実行**: ポートフォリオ管理 → 保有株リスト更新
2. **スクリプトから実行**: `updatePF()`関数を直接実行

### 前提条件
- 注文一覧シートに有効なデータが存在すること
- メインシートが適切な列構成になっていること

## 注意事項

### データの上書き
- メインシートの既存データは完全に上書きされます
- 手動で入力したデータは失われます

### 保有数の計算
- 売却により保有数が0になった銘柄は表示されません
- 平均単価は総コスト÷保有数で計算されます

### 株価の更新
- 株価は数式として設定され、リアルタイムで更新されます
- インターネット接続が必要です 