# 分割処理システム - 使用方法

## 概要

このシステムは、Google Apps Script (GAS) の6分実行制限を回避するため、大きな処理を小さなバッチに分割して確実に完了させる仕組みです。

## 主な特徴

### 1. 自動分割処理
- 119銘柄のデータを3銘柄ずつのバッチに分割
- 各バッチ間に3秒の待機時間
- 4.5分で安全マージンにより自動中断

### 2. 状態保存と継続
- 処理状態を自動保存
- 中断された位置から自動再開
- 進捗状況の詳細追跡

### 3. エラーハンドリング
- 個別銘柄のエラーが全体に影響しない
- 詳細なログ出力
- 失敗した処理の記録

## 使用方法

### 1. 分割処理の開始

サイドバーの「_Reference情報更新（分割処理）」ボタンをクリックします。

```
_Reference情報更新（分割処理） → クリック
```

### 2. 処理の監視

処理中は以下の情報が表示されます：
- 現在のバッチ番号
- 処理済み件数
- 成功率
- 残り時間

### 3. 中断と継続

処理が中断された場合：
- 自動的に状態が保存されます
- 「分割処理を継続」ボタンで再開できます
- 中断された位置から処理が継続されます

### 4. 状態のクリア

必要に応じて「分割処理状態をクリア」ボタンで保存された状態を削除できます。

## 処理フロー

```
1. 処理開始
   ↓
2. バッチ分割（3銘柄ずつ）
   ↓
3. 各バッチ処理
   ├─ 配当金情報取得
   ├─ 分配金情報取得（投資信託のみ）
   ├─ EPS情報取得
   ├─ BPS情報取得
   └─ 権利確定情報取得
   ↓
4. 進捗保存
   ↓
5. バッチ間待機（3秒）
   ↓
6. 次のバッチへ
   ↓
7. 完了または中断
```

## 設定パラメータ

### バッチ処理設定
```javascript
const batchOptions = {
  MAX_BATCH_SIZE: 3,           // 1バッチあたり3銘柄
  SAFE_TIME_MARGIN: 4.5 * 60 * 1000,  // 4.5分で安全マージン
  BATCH_INTERVAL: 3000,        // バッチ間3秒待機
  ITEM_INTERVAL: 1000,         // 銘柄間1秒待機
  PROGRESS_SAVE_INTERVAL: 5    // 5件ごとに進捗保存
};
```

### データソース
- **配当金**: みんかぶ (minkabu.jp)
- **分配金**: Yahoo Finance (finance.yahoo.co.jp)
- **EPS/BPS**: 株探 (kabuyoho.jp)
- **権利確定**: みんかぶ (minkabu.jp)

## ログ出力

### 処理ログ
```
INFO: 分割処理を開始します: 119件中0番目から
INFO: バッチ 1/40 を処理中: 3件
INFO: 4248の配当金情報を取得しました: 36
INFO: バッチ 1/40 完了: 3件処理
```

### エラーログ
```
WARN: 6957の配当金情報取得失敗: 正規表現にマッチしませんでした
ERROR: 8306のEPS情報取得エラー: ネットワークエラー
```

## トラブルシューティング

### よくある問題

1. **処理が中断される**
   - 正常な動作です
   - 「分割処理を継続」ボタンで再開してください

2. **一部の銘柄でエラーが発生**
   - 個別のエラーは全体に影響しません
   - ログで詳細を確認してください

3. **処理が完了しない**
   - 状態をクリアして最初から再実行してください

### パフォーマンス最適化

- バッチサイズを調整（1-5銘柄）
- 待機時間を調整（1-5秒）
- 安全マージンを調整（4-5分）

## 技術仕様

### ファイル構成
```
stockmanagement/
├── batchProcessor.js      # 分割処理エンジン
├── mainController.js      # メイン処理ロジック
├── timeoutManager.js      # タイムアウト管理
├── sidebar.html          # UI
└── README_BATCH_PROCESSING.md  # このファイル
```

### 主要クラス
- `BatchProcessor`: 分割処理の実行
- `MainController`: ビジネスロジック
- `TimeoutManager`: タイムアウト管理
- `LoggerManager`: ログ出力

## 更新履歴

- **v1.0**: 初期リリース
  - 基本的な分割処理機能
  - 状態保存と継続機能
  - エラーハンドリング

## サポート

問題が発生した場合は、以下を確認してください：
1. SystemLogファイルのログ
2. スプレッドシートのエラーメッセージ
3. ネットワーク接続状況 